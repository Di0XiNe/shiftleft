name: Build, Scan, Push, and SBOM Generation

on:
  push:
    branches:
      - main
    paths:
      - 'Dockerfile' # El workflow se ejecuta solo si se modifica el Dockerfile

env:
  # 1. Definimos solo la variable estÃ¡tica aquÃ­
  IMAGE_REPO: quay.io/harik_sc/shift_left

jobs:
  build-scan-push:
    runs-on: ubuntu-latest

    permissions:
      contents: write # PermÃ­s necessari per fer commit i push de l'SBOM
      packages: write # PermÃ­s necessari per al push a Quay

    steps:
      - name: ðŸ§© Checkout code
        uses: actions/checkout@v4

      # âš™ï¸ CORRECCIÃ“N: Definimos variables dinÃ¡micas y las exportamos a GITHUB_ENV
      - name: âš™ï¸ Set Dynamic Image Tags
        run: |
          # Exportamos tags dinÃ¡micos
          echo "IMAGE_TAG_SHA=${{ env.IMAGE_REPO }}:${{ github.sha }}" >> $GITHUB_ENV
          echo "LATEST_IMAGE_TAG=${{ env.IMAGE_REPO }}:latest" >> $GITHUB_ENV
          echo "Tags dinÃ¡micos establecidos."

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”§ Construir la imagen del contenedor
        run: |
          docker build -t ${{ env.IMAGE_TAG_SHA }} -t ${{ env.LATEST_IMAGE_TAG }} .

      # 1. ðŸ” Escaneo RÃ¡pido (Trivy)
      - name: ðŸ” Scan image with Trivy (Falla si hay HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_TAG_SHA }}
          severity: HIGH,CRITICAL
          exit-code: 1
          ignore-unfixed: true

      # 2. ðŸ§¾ Generar SBOM (Syft) - Paso separado para garantizar la escritura
      - name: ðŸ§¾ Generate SBOM (Syft)
        if: success()
        run: |
          echo "Generando SBOM con Syft..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          anchore/syft:latest "${{ env.IMAGE_TAG_SHA }}" -o syft-json > sbom.syft.json
          test -s sbom.syft.json || { echo "Error: SBOM file was not created by Syft." && exit 1; }

      # 3. ðŸ›¡ Escanejar SBOM (Grype)
      # Reemplaza el 'docker run' problemÃ¡tico de Grype
      - name: ðŸ›¡ Vulnerability scan (Grype Action on SBOM)
        if: success()
        uses: anchore/scan-action@v6
        with:
          # Grype Action lee directamente el archivo generado en el paso anterior
          sbom: sbom.syft.json
          severity-cutoff: high # Falla si detecta HIGH o CRITICAL
          fail-build: true
          only-fixed: false

      # Artefacte SBOM (Pujada interna al pipeline - ja estava)
      - name: ðŸ“¤ Upload SBOM artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sbom-syft-json
          path: sbom.syft.json
          if-no-files-found: error
          retention-days: 14

      # ðŸŸ¢ EXTRA: Commit i Push de l'SBOM a la branca main
      - name: ðŸ’¾ Commit SBOM to Git Repository
        if: success()
        run: |
          echo "Subiendo sbom.syft.json al repo de Git para trazabilidad..."
          # Configura l'usuari/bot que fa el commit
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Afegeix l'SBOM i fa commit. '|| true' evita que el workflow falli si no hi ha canvis.
          git add sbom.syft.json
          git commit -m "chore(sbom): Afegir SBOM per al commit ${{ github.sha }}" || echo "No new SBOM file to commit."

          # Puja el commit a la branca main
          # Utilitzem el GITHUB_TOKEN per autenticaciÃ³
          git push

      # 4. ðŸ”‘ Login Seguro (utilizando la acciÃ³n)
      - name: ðŸ”‘ Login to Quay.io (AcciÃ³n Segura)
        if: success()
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USER }}
          password: ${{ secrets.QUAY_PASSWORD }}

      # 5. ðŸš€ Push Condicional
      - name: ðŸš€ Push image to Quay.io
        if: success()
        run: |
          docker push ${{ env.IMAGE_TAG_SHA }}
          docker push ${{ env.LATEST_IMAGE_TAG }}
